\input{paquetes.tex}

\title{	
\normalfont \normalsize 
\textsc{\textbf{Ingeniería de Servidores (2021-2022)} \\ Grado en Ingeniería Informática \\ Universidad de Granada} \\ [25pt] % Your university, school and/or department name(s)
\horrule{0.5pt} \\[0.4cm] % Thin top horizontal rule
\huge Memoria Práctica 3 \\ % The assignment title
\horrule{2pt} \\[0.5cm] % Thick bottom horizontal rule
}

\author{Mario López González} % Nombre y apellidos

\date{\normalsize\today} % Incluye la fecha actual

%----------------------------------------------------------------------------------------
% DOCUMENTO
%----------------------------------------------------------------------------------------

\begin{document}

\maketitle % Muestra el Título

\newpage %inserta un salto de página

\tableofcontents % para generar el índice de contenidos
\listoffigures % para generar el índice de imágenes

\newpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
% Apartado para la instalación en Ubuntu Server %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Instalación de Zabbix en Ubuntu Server}
\subsection{Descargar paquetes de Zabbix 5.0}

    Vamos a descargar los paquetes de Zabbix, para ello entramos en su web oficial, \href{https://www.zabbix.com/download}{Zabbix.com}, y 
    seleccionamos los siguientes parámetros ya que son los que se ajustan a nuestras necesidades.
        
    \begin{figure}[H]
        \centering
        \includegraphics[scale=0.3]{images/zabbix_official.png}
        \caption{Descargar Zabbix desde paquetes}
        \label{fig:zabbix_official}
    \end{figure}

    Lo primero que debemos hacer es descargar los paquetes correspondientes a Zabbix 5.0 desde su repositorio oficial con el comando \textbf{\emph{wget}}. 
        \begin{tcolorbox}[colback=black!10, halign=left]
            \$ wget https://repo.zabbix.com/zabbix/5.0/ubuntu/pool/main/z/zabbix-release/zabbix-release\_5.0-1+focal\_all.deb
        \end{tcolorbox}

    Una vez descargado, lo instalamos el repositorio con el comando \textbf{\emph{dpkg}}.
        \begin{tcolorbox}[colback=black!10, halign=left]
            \$ sudo dpkg -i zabbix-release\_5.0-1+focal\_all.deb
        \end{tcolorbox}

    Por último actualizamos la lista de paquetes disponibles y sus versiones.
        \begin{tcolorbox}[colback=black!10, halign=left]
            \$ sudo apt update
        \end{tcolorbox}

    \newpage
    \subsection{Instalar Zabbix}

    Ya tenemos todos los paquetes descargados y actualizados, por lo tanto, lo siquiente que indica la web es que hay que instalar Zabbix server, frontend
    y agent con el comando \textbf{\emph{apt install}}.
        \begin{tcolorbox}[colback=black!10, halign=left]
            \$ sudo apt install zabbix-server-mysql zabbix-frontend-php zabbix-apache-conf zabbix-agent
        \end{tcolorbox}
    
    \subsection{Crear base de datos inicial}
    Antes de crear la base de datos inicial debemos estar seguros de que el sistema está encendido y funcionando. Una vez hechas las comprobaciones previas,
    pasamos a crear la base de datos. Para ello ingresamos en el asistente de mysql.
        \begin{tcolorbox}[colback=black!10, halign=left]
            \$ sudo mysql -u root -p

            \emph{Ingresamos la contraseña para ingresar en la base de datos (ISE)}
        \end{tcolorbox}

    Una vez dentro del asistente ejecutamos los siguientes comandos en PostgreSQL:
        \begin{tcolorbox}[colback=black!10, halign=left]
            mysql> create database zabbix character set utf8 collate utf8\_bin;

            mysql> create user zabbix@localhost identified by 'ISE';

            mysql> grant all privileges on zabbix.* to zabbix@localhost;

            mysql> quit;
        \end{tcolorbox}

    Definimos la nueva contraseña creada con el siguiente comando y escribimos la contraseña.
        \begin{tcolorbox}[colback=black!10, halign=left]
            \$ sudo zcat /usr/share/doc/zabbix-server-mysql*/create.sql.gz | mysql -uzabbix -p zabbix
            \emph{Ingresamos la contraseña (ISE)}
        \end{tcolorbox}

    \subsection{Configurar la base de datos de Zabbix server}
    Editamos el fichero que se encuentra en la ruta \textbf{/etc/zabbix/zabbix\_server.conf}, descomentamos el parámetro \textbf{\emph{DBPassword}} y le asignamos el valor
    \textbf{\emph{ISE}}:
    \begin{figure}[H]
        \centering
        \includegraphics[scale=0.4]{images/zabbix_server_conf.png}
        \caption{Configuración base de datos}
        \label{fig:zabbix_conf}
    \end{figure}

    \subsection{Configurar el PHP del frontend de Zabbix}
    Editamos el fichero que se encuentra en la ruta \textbf{/etc/zabbix/apache.conf}y modificamos el parámetro comentado \textbf{\emph{php\_value date.timezone}} reemplazando Riga
    por Madrid para que se muestre la hora de forma correcta.
    \begin{figure}[H]
        \centering
        \includegraphics[scale=0.5]{images/apache_conf.png}
        \caption{Configuración base de datos}
        \label{fig:apache_conf}
    \end{figure}

    \subsection{Configurar los servicios}
    Reiniciamos los servicios \textbf{\emph{zabbix-server}}, \textbf{\emph{zabbix-agent}} y \textbf{\emph{apache2}} para que se actualicen los cambios realizados.
        \begin{tcolorbox}[colback=black!10, halign=left]
            \$ sudo systemctl restart zabbix-server zabbix-agent apache2
        \end{tcolorbox}

    Habilitamos los servicios anteriores para que se enciendan cuando arranque el sistema.
        \begin{tcolorbox}[colback=black!10, halign=left]
            \$ sudo systemctl enable zabbix-server zabbix-agent apache2
        \end{tcolorbox}

    \subsection{Habilitar el puerto de escucha}
    Habilitamos el puerto de escucha que usa por defecto Zabbix para que el firewall no lo bloquee.
        \begin{tcolorbox}[colback=black!10, halign=left]
            \$ sudo ufw allow 10051/tcp
        \end{tcolorbox}

    \subsection{Habilitar el puerto de escucha}
    Editamos el fichero \textbf{/etc/zabbix/zabbix\_agentd.conf} cambiando las IP asignadas a las variables Server y ServerActive por la IP de la máquina que actuará de servidor
    \textbf{(192.168.56.105)} y reiniciamos el servicio \textbf{\emph{zabbix-agent}} para que se apliquen los cambios.
        \begin{figure}[H]
            \centering
            \includegraphics[scale=0.45]{images/ubuntu_servers.png}
            \caption{Configuración Server y ServerActive}
            \label{fig:ubuntu_servers}
        \end{figure}
        \begin{tcolorbox}[colback=black!10, halign=left]
            \$ sudo systemctl restart zabbix-agent
        \end{tcolorbox}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
% Apartado para la instalación en CentOS %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\newpage
\section{Instalación de Zabbix en CentOS}
    \subsection{Descargar paquetes de Zabbix 5.0}
    Vamos a descargar los paquetes de Zabbix, para ello entramos en su web oficial, \href{https://www.zabbix.com/download}{Zabbix.com}, y 
    seleccionamos los siguientes parámetros ya que son los que se ajustan a nuestras necesidades.
    \begin{figure}[H]
        \centering
        \includegraphics[scale=0.3]{images/zabbix_centOS.png}
        \caption{Descargar Zabbix desde paquetes}
        \label{fig:zabbix_centOS}
    \end{figure}

    Lo primero que debemos hacer es descargar los paquetes correspondientes a Zabbix 5.0 desde su repositorio oficial con el comando \textbf{\emph{wget}}. 
        \begin{tcolorbox}[colback=black!10, halign=left]
            \# sudo rpm -Uvh https://repo.zabbix.com/zabbix/5.0/rhel/8/x86\_64/zabbix-release-5.0-1.el8.noarch.rpm
        \end{tcolorbox}

    Una vez descargado, limpiamos el directorio.
        \begin{tcolorbox}[colback=black!10, halign=left]
            \# sudo dnf clean all
        \end{tcolorbox}

    Por último, instalamos el servidor, la interfaz y el agente de Zabbix.
        \begin{tcolorbox}[colback=black!10, halign=left]
            \# dnf install zabbix-server-mysql zabbix-web-mysql zabbix-apache-conf zabbix-agent
        \end{tcolorbox}

    \subsection{Habilitar los puertos de escucha}
    Activamos el puerto 10050 ya que es el puerto por defecto del agente de forma permanente con el siguiente comando: 
        \begin{tcolorbox}[colback=black!10, halign=left]
            \# sudo firewall-cmd --add-port=10050/tcp --permanent
        \end{tcolorbox}

    Una vez se ha habilitado, recargamos para que se active sin necesidad de reiniciar la máquina.
    \begin{tcolorbox}[colback=black!10, halign=left]
        \# sudo firewall-cmd --reload
    \end{tcolorbox}
    
    \subsection{Configurar el fichero de agente}
    Editamos el fichero que se encuentra en \textbf{/etc/zabbix/zabbix\_agentd.conf} y cambiamos los parámetos \textbf{\emph{server}} y \textbf{\emph{serverActive}}
    con la IP del servidor que queremos que monitorice este sistema, en nuestro caso \textbf{192.168.56.105}. 

    \begin{figure}[H]
        \centering
        \includegraphics[scale=0.4]{images/centos_servers.png}
        \caption{Configuración Server y ServerActive}
        \label{fig:centos_servers}
    \end{figure}    

    \subsection{Configurar los servicios}
    Reiniciamos los servicios \textbf{\emph{zabbix-server}}, \textbf{\emph{zabbix-agent}} y \textbf{\emph{apache2}} para que se actualicen los cambios realizados.
        \begin{tcolorbox}[colback=black!10, halign=left]
            \# sudo systemctl restart zabbix-server zabbix-agent httpd php-fpm
        \end{tcolorbox}

    Habilitamos los servicios anteriores para que se enciendan cuando arranque el sistema.
        \begin{tcolorbox}[colback=black!10, halign=left]
            \# sudo systemctl enable zabbix-server zabbix-agent httpd php-fpm
        \end{tcolorbox}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
% Apartado para la instalación en CentOS %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\section{Instalación del Front-End}
    \subsection{Página de bienvenida de Zabbix}
    Desde un navegador ingresamos en la dirección \textbf{192.168.56.105/zabbix}. Nos aparecerá una web de bienvenida con la varsión de Zabbix que estamos utilizando. 
    Pulsamos al botón \textbf{\emph{"Next Step"}} para continuar.
    \begin{figure}[H]
        \centering
        \includegraphics[scale=0.25]{images/zabbix_installation_1.png}
        \caption{Página de bienvenida de Zabbix}
        \label{fig:zabbix_installation_1}
    \end{figure}

    \subsection{Requisitos previos de Zabbix}
    En esta sección Zabbix nos muestra una lista de requisitos previos que deben de cumplirse para que todo funcione correctamente, si hubiera algún requisito que no se esté 
    cumpliendo habría que corregirlo. Una vez que verificamos que todos los requisitos se cumplen avanzamos al siguiente apartado pulsando en \textbf{\emph{"Next Step"}}.
    \begin{figure}[H]
        \centering
        \includegraphics[scale=0.25]{images/zabbix_installation_2.png}
        \caption{Requisitos previos de Zabbix}
        \label{fig:zabbix_installation_2}
    \end{figure}

    \subsection{Conexión con la base de datos}
    Configuramos la conexión con la base de datos MySQL, escribimos \textbf{\emph{ISE}} como contraseña.
    \begin{figure}[H]
        \centering
        \includegraphics[scale=0.25]{images/zabbix_installation_3.png}
        \caption{Conexión con la base de datos}
        \label{fig:zabbix_installation_3}
    \end{figure}

    \subsection{Detalles del servidor}
    Ingresamos el nombre del host y el puerto que vamos a utilizar.
    \begin{figure}[H]
        \centering
        \includegraphics[scale=0.25]{images/zabbix_installation_4.png}
        \caption{Detalles del servidor}
        \label{fig:zabbix_installation_4}
    \end{figure} 

    \subsection{Instalación del Front-End}
    Comprobamos que todo está bien antes de instalar ya que no se podrá cambiar ningún parámetro.
    \begin{figure}[H]
        \centering
        \includegraphics[scale=0.25]{images/zabbix_installation_5.png}
        \caption{Instalación del Front-End}
        \label{fig:zabbix_installation_5}
    \end{figure} 
\end{document}
